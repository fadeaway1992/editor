<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>more-editor</title>

  <!-- 引入页面样式文件 -->
  <link rel="stylesheet" href="../css/demo.css">

  <!-- 引入编辑器用到的一些样式 -->
  <link rel="stylesheet" href="../css/more-editor.css">

  <!-- 引入 阿里云 oss-sdk -->
  <script src="https://gosspublic.alicdn.com/aliyun-oss-sdk-4.4.4.min.js"></script>

</head>
<body>
  <div class="toolbar">
    <button class="h2">H2</button>
    <button class="h3">H3</button>
    <button class="ul">无序列表</button>
    <button class="ol">顺序列表</button>
    <button class="quote">quote</button>
    <button class="bold">粗体</button>
    <button class="italic">斜体</button>
    <button class="strike">删除线</button>
    <button class="center">居中</button>
    <div>
      <input class="url" type="input" placeholder="请输入链接地址"><button class="link">Link</button>
      <input type="file" accept="image/*" class="file-upload" style="display:none;">
      <button class="upload-image" onclick="document.querySelector('.file-upload').click()">上传图片</button>
      <button onclick = "document.execCommand('insertHTML', false, '&lt;li&gt;hahah&lt;/li&gt;&lt;li&gt;hahah&lt;/li&gt;')">paste</button>
    </div>
  </div>
  <div class="editable" contenteditable="true"></div>
  <!-- 引入 more-editor -->
  <script src="../js/more-editor.js"></script>

  <!-- 创建 editor 实例  -->
  <script>
    window.onload = function() {

      /* 定义图片上传所需的变量 */
      var client,
          region,
          accessKeyId,
          accessKeySecret,
          stsToken,
          bucket,
          dirName

      function getAliyunToken() {  // Authorization  token PPuEtnV44Rj2dh6LK8tCzR5eae1501208628.0156991
        var ajax = new XMLHttpRequest()
        ajax.open('POST', 'https://hubdemo.duodian.com/api/v1/sae113475d9/user/aliyun_sts_token', false)
        ajax.setRequestHeader('Authorization', 'token PPuEtnV44Rj2dh6LK8tCzR5eae1501208628.0156991')
        ajax.send()

        var response = JSON.parse(ajax.responseText)
        client = new OSS.Wrapper({
          region: 'oss-'+response.oss_area,
          accessKeyId: response.access_key_id,
          secure: true,
          accessKeySecret: response.access_key_secret,
          stsToken: response.security_token,
          bucket: response.oss_bucket_name
        })
        console.log(client,'client')
        region = 'oss-'+response.oss_area
        accessKeyId = response.access_key_id
        accessKeySecret = response.access_key_secret
        stsToken = response.security_token
        bucket = response.oss_bucket_name
        dirName = response.oss_dir_name
      }

      getAliyunToken()

      var editor = new MoreEditor('.editable', {
        imageUpload: function(image, updateURL){
          console.log(image, '这是我要上传的图片，请在这个函数中把这个文件上传到服务器，调用 updateURL, 把线上地址传进去。')
          var time = new Date().getTime().toString()
          var regex = /.*(.jpe?g|.png|.gif)$/
          var extensionName = regex.exec(image.name)
          var fileName = dirName + '/' + time + extensionName[1]

          client.multipartUpload(fileName,image).then(function(res){
            var url = ''
            if (res.url) {
              url = res.url
            } else {
              url = 'https://' + res.bucket + '.' + region + '.aliyuncs.com/' + res.name
            }
            console.log(url, '线上地址')
            updateURL(url)
          })
        },
        sizeAlert:'.size-alert',
        decorateOnlyWhenTextSelected:false,
        buttons: {
          h2: '.h2',
          h3: '.h3',
          ul: '.ul',
          ol: '.ol',
          quote: '.quote',
          bold: '.bold',
          italic: '.italic',
          strike: '.strike',
          url: '.url',
          link: '.link',
          center: '.center',
          imageInput: '.file-upload',
          imageButton: '.upload-image',
          imageOptions: '.image-options',
          imageRechoose: '.rechoose',
          imageRemove: '.delete',
          figCaption: '.figure-caption'
        }
      })
      console.log(editor)

      var editable = document.querySelector('.editable')

      var url = document.querySelector('.url')
      url.addEventListener('blur', editor.API.importSelection.bind(editor.API))
      url.addEventListener('mousedown', editor.API.exportSelection.bind(editor.API))

    }
    
</script>

<!-- 给按钮绑定编辑器事件 -->
<script>
  


</script>
<div class="size-alert" style="display:none;"><p>上传的图片大小不能超过 10Mb </p><button onclick = "this.parentNode.style.display = 'none'">确定</button></div>
<div class="image-options" style="display:none;"><button class="rechoose">替换</button><button class="figure-caption">注释</button><button class="delete">移除</button></div>

</body>
</html>

